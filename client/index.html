<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quik - Социальная сеть</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #5181b8;
            --primary-dark: #3a5a8a;
            --secondary: #e64646;
            --bg: #eaeff2;
            --white: #ffffff;
            --text: #000000;
            --text-secondary: #939393;
            --border: #e7e8ec;
            --green: #4bb34b;
        }

        body {
            background: var(--bg);
            color: var(--text);
        }

        /* Header */
        .header {
            background: var(--white);
            height: 50px;
            display: flex;
            align-items: center;
            padding: 0 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
            margin-right: 40px;
        }

        .search-box {
            flex: 1;
            max-width: 400px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 8px 12px;
            padding-left: 35px;
            border: none;
            background: #f0f2f5;
            border-radius: 10px;
            outline: none;
        }

        .search-box i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .header-nav {
            display: flex;
            gap: 20px;
            margin-left: auto;
        }

        .header-nav a {
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .header-nav a:hover, .header-nav a.active {
            color: var(--primary);
        }

        .user-avatar-small {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
        }

        /* Main Layout */
        .container {
            display: flex;
            padding-top: 60px;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Left Sidebar */
        .sidebar {
            width: 150px;
            padding: 20px 0;
            position: fixed;
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-menu li {
            padding: 10px 15px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s;
        }

        .sidebar-menu li:hover, .sidebar-menu li.active {
            background: #e5ebf1;
        }

        .sidebar-menu li i {
            color: var(--primary);
            width: 20px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 170px;
            padding: 20px;
            max-width: 800px;
        }

        /* Right Sidebar */
        .right-sidebar {
            width: 300px;
            padding: 20px;
            position: fixed;
            right: 0;
            top: 60px;
            height: calc(100vh - 60px);
            overflow-y: auto;
        }

        /* Auth Screen */
        .auth-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .auth-box {
            background: var(--white);
            padding: 40px;
            border-radius: 20px;
            width: 400px;
            text-align: center;
        }

        .auth-box h1 {
            color: var(--primary);
            margin-bottom: 30px;
            font-size: 36px;
        }

        .auth-box input {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
        }

        .auth-box button {
            width: 100%;
            padding: 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .auth-box button:hover {
            background: var(--primary-dark);
        }

        .auth-box .switch {
            margin-top: 20px;
            color: var(--primary);
            cursor: pointer;
        }

        /* Create Post */
        .create-post {
            background: var(--white);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .create-post-top {
            display: flex;
            gap: 10px;
        }

        .create-post textarea {
            flex: 1;
            border: none;
            resize: none;
            outline: none;
            font-size: 14px;
            padding: 10px;
        }

        .create-post-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 10px;
            border-top: 1px solid var(--border);
            margin-top: 10px;
        }

        .create-post-actions label {
            color: var(--primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .create-post-actions button {
            padding: 8px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        /* Post */
        .post {
            background: var(--white);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .post-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .post-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .post-author {
            font-weight: 600;
        }

        .post-time {
            color: var(--text-secondary);
            font-size: 12px;
        }

        .post-content {
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .post-image {
            width: 100%;
            max-height: 500px;
            object-fit: contain;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .post-actions {
            display: flex;
            gap: 20px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
        }

        .post-action {
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.2s;
        }

        .post-action:hover, .post-action.liked {
            color: var(--secondary);
        }

        /* Comments */
        .comments-section {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
        }

        .comment {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .comment-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
        }

        .comment-content {
            background: #f0f2f5;
            padding: 8px 12px;
            border-radius: 18px;
        }

        .comment-author {
            font-weight: 600;
            font-size: 12px;
        }

        .comment-text {
            font-size: 13px;
        }

        .comment-input {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .comment-input input {
            flex: 1;
            padding: 8px 12px;
            border: none;
            background: #f0f2f5;
            border-radius: 20px;
            outline: none;
        }

        /* Messenger */
        .messenger {
            background: var(--white);
            border-radius: 12px;
            height: calc(100vh - 100px);
            display: flex;
            overflow: hidden;
        }

        .messenger-contacts {
            width: 300px;
            border-right: 1px solid var(--border);
            overflow-y: auto;
        }

        .messenger-contacts h3 {
            padding: 15px;
            border-bottom: 1px solid var(--border);
        }

        .contact {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .contact:hover, .contact.active {
            background: #f0f2f5;
        }

        .contact-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
        }

        .contact-name {
            font-weight: 600;
        }

        .contact-preview {
            color: var(--text-secondary);
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .messenger-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 18px;
        }

        .message.sent {
            background: var(--primary);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .message.received {
            background: #f0f2f5;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .chat-input {
            padding: 15px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 12px 15px;
            border: none;
            background: #f0f2f5;
            border-radius: 24px;
            outline: none;
        }

        .chat-input button {
            padding: 12px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 24px;
            cursor: pointer;
        }

        /* Groups */
        .groups-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .group-card {
            background: var(--white);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .group-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .group-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 10px;
            background: var(--bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            color: var(--primary);
        }

        .group-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .group-members {
            color: var(--text-secondary);
            font-size: 13px;
        }

        /* Create Group Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--white);
            padding: 30px;
            border-radius: 12px;
            width: 450px;
        }

        .modal-content h2 {
            margin-bottom: 20px;
        }

        .modal-content input, .modal-content textarea {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
        }

        .modal-content button {
            padding: 12px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-right: 10px;
        }

        .modal-content .cancel {
            background: #f0f2f5;
            color: var(--text);
        }

        /* Profile */
        .profile-header {
            background: var(--white);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .profile-cover {
            height: 200px;
            background: linear-gradient(135deg, var(--primary) 0%, #764ba2 100%);
        }

        .profile-info {
            padding: 20px;
            display: flex;
            gap: 20px;
            position: relative;
        }

        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 4px solid var(--white);
            object-fit: cover;
            position: absolute;
            top: -60px;
            background: var(--white);
        }

        .profile-details {
            margin-top: 70px;
            flex: 1;
        }

        .profile-name {
            font-size: 24px;
            font-weight: 600;
        }

        .profile-username {
            color: var(--text-secondary);
        }

        .profile-bio {
            margin-top: 10px;
            color: var(--text-secondary);
        }

        /* Hidden */
        .hidden {
            display: none !important;
        }

        /* Notifications */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--white);
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            z-index: 4000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.error {
            border-left: 4px solid var(--secondary);
        }

        .notification.success {
            border-left: 4px solid var(--green);
        }

        /* Users List */
        .users-list {
            background: var(--white);
            border-radius: 12px;
            padding: 15px;
        }

        .user-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .user-item:hover {
            background: #f0f2f5;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-info h4 {
            font-weight: 600;
        }

        .user-info p {
            color: var(--text-secondary);
            font-size: 13px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #aaa;
        }

        /* Online indicator */
        .online-indicator {
            width: 12px;
            height: 12px;
            background: var(--green);
            border-radius: 50%;
            position: absolute;
            bottom: 0;
            right: 0;
            border: 2px solid var(--white);
        }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="authScreen" class="auth-screen">
        <div class="auth-box">
            <h1><i class="fas fa-bolt"></i> Quik</h1>
            <div id="loginForm">
                <input type="email" id="loginEmail" placeholder="Email">
                <input type="password" id="loginPassword" placeholder="Пароль">
                <button onclick="login()">Войти</button>
                <p class="switch" onclick="showRegister()">Нет аккаунта? Зарегистрироваться</p>
            </div>
            <div id="registerForm" class="hidden">
                <input type="text" id="regUsername" placeholder="Имя пользователя">
                <input type="text" id="regFirstName" placeholder="Имя">
                <input type="text" id="regLastName" placeholder="Фамилия">
                <input type="email" id="regEmail" placeholder="Email">
                <input type="password" id="regPassword" placeholder="Пароль">
                <button onclick="register()">Зарегистрироваться</button>
                <p class="switch" onclick="showLogin()">Есть аккаунт? Войти</p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header class="header">
            <div class="logo">Quik</div>
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Поиск" onkeyup="searchUsers(this.value)">
            </div>
            <nav class="header-nav">
                <a onclick="showSection('feed')" id="navFeed" class="active"><i class="fas fa-newspaper"></i></a>
                <a onclick="showSection('messenger')" id="navMessenger"><i class="fas fa-envelope"></i></a>
                <a onclick="showSection('groups')" id="navGroups"><i class="fas fa-users"></i></a>
                <a onclick="showSection('profile')" id="navProfile">
                    <img id="headerAvatar" class="user-avatar-small" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%235181b8'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E" alt="">
                </a>
            </nav>
        </header>

        <div class="container">
            <!-- Left Sidebar -->
            <aside class="sidebar">
                <ul class="sidebar-menu">
                    <li onclick="showSection('feed')" class="active" id="menuFeed"><i class="fas fa-newspaper"></i> Новости</li>
                    <li onclick="showSection('profile')" id="menuProfile"><i class="fas fa-user"></i> Моя страница</li>
                    <li onclick="showSection('messenger')" id="menuMessenger"><i class="fas fa-envelope"></i> Сообщения</li>
                    <li onclick="showSection('groups')" id="menuGroups"><i class="fas fa-users"></i> Группы</li>
                    <li onclick="showSection('users')" id="menuUsers"><i class="fas fa-user-friends"></i> Друзья</li>
                </ul>
            </aside>

            <!-- Main Content -->
            <main class="main-content" id="mainContent">
                <!-- Feed Section -->
                <section id="feedSection">
                    <div class="create-post">
                        <div class="create-post-top">
                            <img id="createPostAvatar" class="post-avatar" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%235181b8'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E" alt="">
                            <textarea id="postContent" placeholder="Что у вас нового?" rows="3"></textarea>
                        </div>
                        <div class="create-post-actions">
                            <label>
                                <i class="fas fa-image"></i> Фото
                                <input type="file" id="postImage" accept="image/*" style="display:none" onchange="previewPostImage(this)">
                            </label>
                            <div id="postImagePreview" class="hidden" style="margin-right: 10px;">
                                <img id="previewImg" style="max-width: 100px; max-height: 100px; border-radius: 8px;">
                                <span onclick="removePostImage()" style="cursor:pointer; color: red;">✕</span>
                            </div>
                            <button onclick="createPost()">Отправить</button>
                        </div>
                    </div>
                    <div id="postsFeed"></div>
                </section>

                <!-- Messenger Section -->
                <section id="messengerSection" class="hidden">
                    <div class="messenger">
                        <div class="messenger-contacts">
                            <h3>Сообщения</h3>
                            <div id="conversationsList"></div>
                        </div>
                        <div class="messenger-chat" id="chatArea">
                            <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-secondary);">
                                Выберите чат для начала общения
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Groups Section -->
                <section id="groupsSection" class="hidden">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>Группы</h2>
                        <button onclick="openCreateGroupModal()" style="padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer;">
                            <i class="fas fa-plus"></i> Создать группу
                        </button>
                    </div>
                    <div id="groupsGrid" class="groups-grid"></div>
                </section>

                <!-- Users Section -->
                <section id="usersSection" class="hidden">
                    <h2 style="margin-bottom: 20px;">Поиск людей</h2>
                    <div id="usersList" class="users-list"></div>
                </section>

                <!-- Profile Section -->
                <section id="profileSection" class="hidden">
                    <div class="profile-header">
                        <div class="profile-cover"></div>
                        <div class="profile-info">
                            <img id="profileAvatar" class="profile-avatar" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%235181b8'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E" alt="">
                            <div class="profile-details">
                                <h1 class="profile-name" id="profileName">Имя Фамилия</h1>
                                <p class="profile-username" id="profileUsername">@username</p>
                                <p class="profile-bio" id="profileBio">Биография</p>
                            </div>
                        </div>
                    </div>
                    <div id="profilePosts"></div>
                </section>
            </main>
        </div>
    </div>

    <!-- Create Group Modal -->
    <div id="createGroupModal" class="modal">
        <div class="modal-content">
            <h2>Создание группы</h2>
            <input type="text" id="groupName" placeholder="Название группы">
            <textarea id="groupDescription" placeholder="Описание группы" rows="3"></textarea>
            <button onclick="createGroup()">Создать</button>
            <button class="cancel" onclick="closeCreateGroupModal()">Отмена</button>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification hidden"></div>

    <script>
        // Global state
        let currentUser = null;
        let token = localStorage.getItem('quik_token');
        let currentConversation = null;
        let postsData = [];
        let groupsData = [];
        let usersData = [];
        let conversationsData = [];
        let searchTimeout = null;

        // API URL - automatically detect current host
        const API_URL = (window.location.protocol + '//' + window.location.host) + '/api';

        // Check auth on load
        window.onload = async () => {
            if (token) {
                try {
                    const response = await fetch(`${API_URL}/auth/me`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.ok) {
                        currentUser = await response.json();
                        showMainApp();
                    } else {
                        localStorage.removeItem('quik_token');
                        token = null;
                    }
                } catch (e) {
                    console.error(e);
                }
            }
        };

        // Auth functions
        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }

        function showLogin() {
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
        }

        async function register() {
            const username = document.getElementById('regUsername').value;
            const firstName = document.getElementById('regFirstName').value;
            const lastName = document.getElementById('regLastName').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;

            if (!username || !email || !password) {
                showNotification('Заполните все поля', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, firstName, lastName, email, password })
                });

                const data = await response.json();
                if (response.ok) {
                    token = data.token;
                    currentUser = data.user;
                    localStorage.setItem('quik_token', token);
                    showMainApp();
                } else {
                    showNotification(data.error || 'Ошибка регистрации', 'error');
                }
            } catch (e) {
                showNotification('Ошибка соединения', 'error');
            }
        }

        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showNotification('Заполните все поля', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();
                if (response.ok) {
                    token = data.token;
                    currentUser = data.user;
                    localStorage.setItem('quik_token', token);
                    showMainApp();
                } else {
                    showNotification(data.error || 'Ошибка входа', 'error');
                }
            } catch (e) {
                showNotification('Ошибка соединения', 'error');
            }
        }

        function showMainApp() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            updateUserUI();
            loadPosts();
            loadGroups();
            loadUsers();
            loadConversations();
        }

        function updateUserUI() {
            const avatarUrl = currentUser.avatar ? (window.location.protocol + '//' + window.location.host + currentUser.avatar) : 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%235181b8"%3E%3Cpath d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/%3E%3C/svg%3E';
            
            document.getElementById('headerAvatar').src = avatarUrl;
            document.getElementById('createPostAvatar').src = avatarUrl;
            document.getElementById('profileAvatar').src = avatarUrl;
            document.getElementById('profileName').textContent = `${currentUser.firstName} ${currentUser.lastName}`.trim() || currentUser.username;
            document.getElementById('profileUsername').textContent = '@' + currentUser.username;
            document.getElementById('profileBio').textContent = currentUser.bio || 'Нет информации о себе';
        }

        // Navigation
        function showSection(section) {
            // Update nav
            document.querySelectorAll('.header-nav a').forEach(a => a.classList.remove('active'));
            document.querySelectorAll('.sidebar-menu li').forEach(li => li.classList.remove('active'));
            
            // Update sections
            document.getElementById('feedSection').classList.add('hidden');
            document.getElementById('messengerSection').classList.add('hidden');
            document.getElementById('groupsSection').classList.add('hidden');
            document.getElementById('usersSection').classList.add('hidden');
            document.getElementById('profileSection').classList.add('hidden');

            if (section === 'feed') {
                document.getElementById('feedSection').classList.remove('hidden');
                document.getElementById('navFeed').classList.add('active');
                document.getElementById('menuFeed').classList.add('active');
                loadPosts();
            } else if (section === 'messenger') {
                document.getElementById('messengerSection').classList.remove('hidden');
                document.getElementById('navMessenger').classList.add('active');
                document.getElementById('menuMessenger').classList.add('active');
                loadConversations();
            } else if (section === 'groups') {
                document.getElementById('groupsSection').classList.remove('hidden');
                document.getElementById('navGroups').classList.add('active');
                document.getElementById('menuGroups').classList.add('active');
                loadGroups();
            } else if (section === 'users') {
                document.getElementById('usersSection').classList.remove('hidden');
                document.getElementById('menuUsers').classList.add('active');
                loadUsers();
            } else if (section === 'profile') {
                document.getElementById('profileSection').classList.remove('hidden');
                document.getElementById('navProfile').classList.add('active');
                document.getElementById('menuProfile').classList.add('active');
                loadProfilePosts();
            }
        }

        // Posts
        async function loadPosts() {
            try {
                const response = await fetch(`${API_URL}/posts`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    postsData = await response.json();
                    renderPosts(postsData);
                }
            } catch (e) {
                console.error(e);
            }
        }

        function renderPosts(posts) {
            const feed = document.getElementById('postsFeed');
            feed.innerHTML = posts.map(post => `
                <div class="post" data-id="${post.id}">
                    <div class="post-header">
                        <img class="post-avatar" src="${post.authorAvatar ? 'http://localhost:3000' + post.authorAvatar : 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%235181b8"%3E%3Cpath d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/%3E%3C/svg%3E'}" alt="">
                        <div>
                            <div class="post-author">${post.authorName}</div>
                            <div class="post-time">${formatDate(post.createdAt)}</div>
                        </div>
                    </div>
                    <div class="post-content">${post.content}</div>
                    ${post.image ? `<img class="post-image" src="http://localhost:3000${post.image}" alt="">` : ''}
                    <div class="post-actions">
                        <div class="post-action ${post.isLiked ? 'liked' : ''}" onclick="likePost('${post.id}')">
                            <i class="fas fa-heart"></i> <span>${post.likesCount || 0}</span>
                        </div>
                        <div class="post-action" onclick="toggleComments('${post.id}')">
                            <i class="fas fa-comment"></i> <span>${post.commentsCount || 0}</span>
                        </div>
                    </div>
                    <div class="comments-section hidden" id="comments-${post.id}">
                        <div id="comments-list-${post.id}"></div>
                        <div class="comment-input">
                            <input type="text" id="comment-input-${post.id}" placeholder="Написать комментарий..." onkeyup="submitComment(event, '${post.id}')">
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function createPost() {
            const content = document.getElementById('postContent').value;
            const imageInput = document.getElementById('postImage');
            
            if (!content && !imageInput.files[0]) {
                showNotification('Введите текст или выберите фото', 'error');
                return;
            }

            try {
                let image = '';
                
                if (imageInput.files[0]) {
                    const formData = new FormData();
                    formData.append('image', imageInput.files[0]);
                    
                    const uploadResponse = await fetch(`${API_URL}/posts/upload`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: formData
                    });
                    
                    if (uploadResponse.ok) {
                        const uploadData = await uploadResponse.json();
                        image = uploadData.image;
                    }
                }

                const response = await fetch(`${API_URL}/posts`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ content, image })
                });

                if (response.ok) {
                    document.getElementById('postContent').value = '';
                    document.getElementById('postImage').value = '';
                    document.getElementById('postImagePreview').classList.add('hidden');
                    loadPosts();
                    showNotification('Пост опубликован!', 'success');
                }
            } catch (e) {
                showNotification('Ошибка публикации', 'error');
            }
        }

        function previewPostImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('postImagePreview').classList.remove('hidden');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function removePostImage() {
            document.getElementById('postImage').value = '';
            document.getElementById('postImagePreview').classList.add('hidden');
        }

        async function likePost(postId) {
            try {
                const response = await fetch(`${API_URL}/posts/${postId}/like`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const postEl = document.querySelector(`.post[data-id="${postId}"]`);
                    const likeBtn = postEl.querySelector('.post-action:first-child');
                    likeBtn.classList.toggle('liked');
                    likeBtn.querySelector('span').textContent = data.likesCount;
                }
            } catch (e) {
                console.error(e);
            }
        }

        function toggleComments(postId) {
            const commentsSection = document.getElementById(`comments-${postId}`);
            commentsSection.classList.toggle('hidden');
            if (!commentsSection.classList.contains('hidden')) {
                loadComments(postId);
            }
        }

        async function loadComments(postId) {
            const post = postsData.find(p => p.id === postId);
            if (!post) return;

            const commentsList = document.getElementById(`comments-list-${postId}`);
            commentsList.innerHTML = (post.comments || []).map(comment => `
                <div class="comment">
                    <img class="comment-avatar" src="${comment.authorAvatar ? 'http://localhost:3000' + comment.authorAvatar : 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%235181b8"%3E%3Cpath d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/%3E%3C/svg%3E'}" alt="">
                    <div class="comment-content">
                        <div class="comment-author">${comment.authorName}</div>
                        <div class="comment-text">${comment.text}</div>
                    </div>
                </div>
            `).join('');
        }

        async function submitComment(event, postId) {
            if (event.key === 'Enter') {
                const input = document.getElementById(`comment-input-${postId}`);
                const text = input.value.trim();
                
                if (!text) return;

                try {
                    const response = await fetch(`${API_URL}/posts/${postId}/comment`, {
                        method: 'POST',
                        headers: { 
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ text })
                    });

                    if (response.ok) {
                        input.value = '';
                        const newComment = await response.json();
                        const post = postsData.find(p => p.id === postId);
                        if (post) {
                            post.comments = post.comments || [];
                            post.comments.push(newComment);
                            loadComments(postId);
                        }
                    }
                } catch (e) {
                    console.error(e);
                }
            }
        }

        // Groups
        async function loadGroups() {
            try {
                const response = await fetch(`${API_URL}/groups`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    groupsData = await response.json();
                    renderGroups(groupsData);
                }
            } catch (e) {
                console.error(e);
            }
        }

        function renderGroups(groups) {
            const grid = document.getElementById('groupsGrid');
            grid.innerHTML = groups.map(group => `
                <div class="group-card" onclick="openGroup('${group.id}')">
                    <div class="group-avatar">
                        ${group.avatar ? `<img src="http://localhost:3000${group.avatar}" alt="">` : '<i class="fas fa-users"></i>'}
                    </div>
                    <div class="group-name">${group.name}</div>
                    <div class="group-members">${group.membersCount || 0} участников</div>
                    ${!group.isMember ? `<button onclick="event.stopPropagation(); joinGroup('${group.id}')" style="margin-top: 10px; padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer;">Вступить</button>` : ''}
                </div>
            `).join('');
        }

        async function createGroup() {
            const name = document.getElementById('groupName').value;
            const description = document.getElementById('groupDescription').value;

            if (!name) {
                showNotification('Введите название группы', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/groups`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, description })
                });

                if (response.ok) {
                    closeCreateGroupModal();
                    loadGroups();
                    showNotification('Группа создана!', 'success');
                }
            } catch (e) {
                showNotification('Ошибка создания группы', 'error');
            }
        }

        async function joinGroup(groupId) {
            try {
                const response = await fetch(`${API_URL}/groups/${groupId}/join`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    loadGroups();
                    showNotification('Вы вступили в группу!', 'success');
                }
            } catch (e) {
                showNotification('Ошибка', 'error');
            }
        }

        function openGroup(groupId) {
            showNotification('Функция в разработке', 'success');
        }

        function openCreateGroupModal() {
            document.getElementById('createGroupModal').classList.add('active');
        }

        function closeCreateGroupModal() {
            document.getElementById('createGroupModal').classList.remove('active');
            document.getElementById('groupName').value = '';
            document.getElementById('groupDescription').value = '';
        }

        // Users
        async function loadUsers() {
            try {
                const response = await fetch(`${API_URL}/users`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    usersData = await response.json();
                    renderUsers(usersData);
                }
            } catch (e) {
                console.error(e);
            }
        }

        function renderUsers(users) {
            const list = document.getElementById('usersList');
            list.innerHTML = users.filter(u => u.id !== currentUser.id).map(user => `
                <div class="user-item" onclick="openChat('${user.id}')">
                    <img class="user-avatar" src="${user.avatar ? 'http://localhost:3000' + user.avatar : 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%235181b8"%3E%3Cpath d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/%3E%3C/svg%3E'}" alt="">
                    <div class="user-info">
                        <h4>${user.firstName} ${user.lastName}</h4>
                        <p>@${user.username}</p>
                    </div>
                </div>
            `).join('');
        }

        function searchUsers(query) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                if (query.length < 2) {
                    loadUsers();
                    return;
                }
                
                try {
                    const response = await fetch(`${API_URL}/users/search/${query}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.ok) {
                        const users = await response.json();
                        renderUsers(users);
                    }
                } catch (e) {
                    console.error(e);
                }
            }, 300);
        }

        // Messenger
        async function loadConversations() {
            try {
                const response = await fetch(`${API_URL}/messages/conversations`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    conversationsData = await response.json();
                    renderConversations();
                }
            } catch (e) {
                console.error(e);
            }
        }

        function renderConversations() {
            const list = document.getElementById('conversationsList');
            list.innerHTML = conversationsData.map(conv => `
                <div class="contact ${currentConversation === conv.id ? 'active' : ''}" onclick="openConversation('${conv.id}', '${conv.otherUser?.id}')">
                    <img class="contact-avatar" src="${conv.otherUser?.avatar ? 'http://localhost:3000' + conv.otherUser.avatar : 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%235181b8"%3E%3Cpath d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/%3E%3C/svg%3E'}" alt="">
                    <div>
                        <div class="contact-name">${conv.otherUser?.firstName || ''} ${conv.otherUser?.lastName || ''}</div>
                        <div class="contact-preview">${conv.lastMessage?.text || 'Нет сообщений'}</div>
                    </div>
                </div>
            `).join('');
        }

        async function openConversation(convId, userId) {
            currentConversation = convId;
            renderConversations();

            try {
                const response = await fetch(`${API_URL}/messages/${convId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const messages = await response.json();
                    const conv = conversationsData.find(c => c.id === convId);
                    
                    const chatArea = document.getElementById('chatArea');
                    chatArea.innerHTML = `
                        <div class="chat-header">
                            <img class="contact-avatar" src="${conv?.otherUser?.avatar ? 'http://localhost:3000' + conv.otherUser.avatar : 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%235181b8"%3E%3Cpath d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/%3E%3C/svg%3E'}" alt="">
                            <span>${conv?.otherUser?.firstName || ''} ${conv?.otherUser?.lastName || ''}</span>
                        </div>
                        <div class="chat-messages" id="chatMessages">
                            ${messages.map(m => `
                                <div class="message ${m.senderId === currentUser.id ? 'sent' : 'received'}">
                                    ${m.text}
                                </div>
                            `).join('')}
                        </div>
                        <div class="chat-input">
                            <input type="text" id="messageInput" placeholder="Сообщение..." onkeyup="sendMessage(event, '${convId}')">
                            <button onclick="sendMessageClick('${convId}')"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    `;
                    
                    // Scroll to bottom
                    const chatMessages = document.getElementById('chatMessages');
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function openChat(userId) {
            try {
                const response = await fetch(`${API_URL}/messages/conversation/${userId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const conv = await response.json();
                    openConversation(conv.id, userId);
                    showSection('messenger');
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function sendMessage(event, convId) {
            if (event.key === 'Enter') {
                sendMessageClick(convId);
            }
        }

        async function sendMessageClick(convId) {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text) return;

            try {
                const response = await fetch(`${API_URL}/messages/${convId}`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ text })
                });

                if (response.ok) {
                    input.value = '';
                    openConversation(convId);
                }
            } catch (e) {
                console.error(e);
            }
        }

        // Profile posts
        async function loadProfilePosts() {
            try {
                const response = await fetch(`${API_URL}/posts/user/${currentUser.id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const posts = await response.json();
                    renderPosts(posts);
                }
            } catch (e) {
                console.error(e);
            }
        }

        // Utility functions
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diff = now - date;
            
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'только что';
            if (minutes < 60) return `${minutes} мин. назад`;
            if (hours < 24) return `${hours} ч. назад`;
            if (days < 7) return `${days} дн. назад`;
            
            return date.toLocaleDateString('ru');
        }

        function showNotification(message, type = 'success') {
            const notif = document.getElementById('notification');
            notif.textContent = message;
            notif.className = `notification ${type}`;
            
            setTimeout(() => {
                notif.classList.add('hidden');
            }, 3000);
        }
    </script>
</body>
</html>
